# Лента постов от друзей

## Оглавление

- [Подготовка](#Подготовка)
    - [Изменение структуры проекта](#изменение-структуры-проекта)
    - [Переход на UUIDv7](#переход-на-uuidv7)

## Подготовка

### Изменение структуры проекта

Функциональность ленты постов отлично подходит для практики по микросервисной архитектуре, поэтому я выделил функциональность работы с
пользователем (регистрация, поиск, дружба) в сервис **user-service**, а для ленты постов разработал новый сервис **post-service**.

### Переход на UUIDv7

В микросервисной архитектуре использование SERIAL ID — является антипаттерном. Поэтому, в первую очередь, я решил перевести сервис
**user-service** на UUIDv7.

#### Почему UUIDv7?

**\+** он поддерживает последовательную сортировку, дефакто новый стандарт\
**\+** будет нативно поддерживаться в PostgreSQL 18\
**\+** легок и просто в обращении

**\-** занимает 128 бит, в отличии от более сложных решений (Twitter Snowflake, Sonyflake), что особенно важно в высоконагруженных системах

#### Как установить

Есть минимум три варианта, как получить функции генерации UUIDv7 на своем PostgreSQL <=17:

1. Использовать расширение [pg_uuidv7](https://github.com/fboulnois/pg_uuidv7)
2. Использование расширения `uuid-ossp` с кастомной функцией
3. Написать свою или найти примеры функций для PostgreSQL

Я пошел по первому пути, так как хотел использовать унифицированное переносимое решение. По ссылке выше описан процесс установки и
компиляции из исходников. После чего остается только выполнить на `pg-master` команду:

```sql
CREATE EXTENSION pg_uuidv7;
```

И можно использовать функцию:

```sql
SELECT uuid_generate_v7();
-- 019971bf-a13b-7fae-81e2-9880257bfba4
```

#### Миграция со старого ID

Создаем новую колонку и удаляем старую:

```sql
START TRANSACTION;

ALTER TABLE users RENAME COLUMN user_id TO user_id_old;
ALTER TABLE users ADD COLUMN user_id uuid DEFAULT uuid_generate_v7();
ALTER TABLE users DROP CONSTRAINT users_pkey, ADD PRIMARY KEY (user_id);
ALTER TABLE users DROP COLUMN user_id_old;

COMMIT;

```

Создаем индексы для новой колонки и выполняем вакуум:

```sql
CREATE UNIQUE INDEX CONCURRENTLY users_uuid_idx ON users(user_id);
VACUUM ANALYZE users;

```

Пример результата:

```
select * from users limit 1;

-[ RECORD 1 ]------------------------------------------------------------
first_name | Ева
last_name  | Абрамова
birth_date | 2010-01-01
gender     | 
interests  | 
city_id    | 197
username   | abramovae3261
password   | $2a$04$OGuod6JuDmEsUdK/MgN4AOpGkn0jjKVLdQE4DLhC1y9FnT6YQFbmi
user_id    | 01997291-1f62-72f5-b07b-92aefafd6b16
```
