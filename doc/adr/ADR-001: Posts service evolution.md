# ADR-001: Эволюция архитектуры сервиса постов

**Дата:** 18.10.2025

**Статус:** В работе

## Контекст

Новые требования от бизнеса: лента постов должна обновляться в режиме реального времени у пользователей, находящихся онлайн.

Для решения потребуется добавить в сервис постов поддержку веб-сокетов. В текущей архитектуре сервис постов отвечает за CRUD-операции и
формирование ленты постов для пользователей, что само по себе нарушает SRP, а при добавлении веб-сокетов мы рискуем получить нестабильный,
сложный в развитии и тестировании сервис. 

Поэтому мы их разделим. При этом требуется обеспечить:

- высокий throughput на создание постов, он должен отвечать только за CRUD-операции
- высокий RPS на получение ленты постов друзей
- отображение новых постов в ленте в режиме реального времени

И уложиться в срок в одну неделю на всю трансформацию, чтобы успеть выполнить следующие ДЗ.

## Решение

Работы будут проведены над четырьмя сервисами. На уровне C2 архитектура будет выглядеть так:

![C2_v2.svg](../arch/c4/C2_v2.svg)

Коммуникацию между сервисами обеспечит RabbitMQ.

### Posts service

Функционал ленты постов из Posts service переедет в отдельный Feed service, тем самым оставим в Posts service только CRUD-операции. При
этом коммуникация между сервисами будет проходить по Event Driven и REST API.

![C3-posts-service_v2.svg](../arch/c4/C3-posts-service_v2.svg)

### Feed service

Новый сервис будет отвечать за:

1. Отдачу актуальной ленты для активных пользователей через веб-сокеты
2. Построения ленты для новых или давно не заходивших в систему пользователей
3. Кэширование ленты активных пользователей

Реализацию веб-сокетного соединения возложена на данный сервис, так как это деталь реализации и у нее нет отдельного контекста в DDD.

![C3-feed-service_v1.svg](../arch/c4/C3-feed-service_v1.svg)

### Posts fanout service

Еще один сервис мы назовем Posts fanout service. В его задачи войдет:

1. Получать от Posts service события по созданию новых постов
2. Получать список друзей автора поста
3. Определение друзей, кому отправлять новый пост в ленту
4. Передачу команды на обновление ленты в Feed service

\<arh scheme TBD\>

### User service

Сервис должен уметь передавать только активных пользователей в списке друзей. Активным пользователь считается тот, кто заходил за последние
сутки — именно столько мы будем хранить и актулизировать ленты.

## Причины

На появление двух новых сервисов повлияли следующие факторы:

1. Создание постов должно иметь высокий throughput, чтобы пользователи не ждали сохранения новых постов. Формирование ленты, получение
   списка друзей, определение кому именно сделать рассылку, веб-сокетное соединение — всё это не его отвественность.
2. Лента должна иметь высокий RPS, чтобы пользователи получали ее мгновенно при входе в приложение. Мы не должны грузить ее процессами
   поиска активных пользователей, определения селебрити. В тоже время мы добавляем в нее функционал веб-сокетов для максимального
   быстродействия.
3. Так как ни один из вышеперечисленных сервисов не может взять на себя логику по определению получаетелей постов — мы выделяем новый
   сервис.
4. Так как мы сильно ограничены во времени — мы используем только RabbitMQ.

## Последствия

Основные компромисы данного архитектурного решения в том, что мы не используем Kafka. Именно через в нее должен публиковать сообщения
Posts service, чтобы сохранять исторические данные.

Так из схем видно, что мы не используем Redis для хранения постов и лент в памяти. Это будет реализовано в последующих ADR.
