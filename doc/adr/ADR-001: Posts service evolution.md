# ADR-001: Эволюция архитектуры сервиса постов

**Дата:** 18.10.2025
**Статус:** В работе

## Контекст

Новые требования от бизнеса: лента постов должна обновляться в режиме реального времени у пользователей, находящихся онлайн. 

Для решения потребуется добавить в сервис постов поддержку веб-сокетов. В текущей архитектуре сервис постов отвечает за CRUD-операции и 
формирование ленты постов для пользователей, что само по себе нарушает SRP, а при добавлении веб-сокетов мы рискуем получить нестабильный 
и сложный в развитии и тестировании сервис. Поэтому мы их разделим.

Требуется обеспечить:
- высокий RPS в сервисе постов — он должен отвечать только за CRUD-операции над постами
- высокий RPS на получение ленты постов
- отображение новых постов в режиме реального времени для онлайн пользователей 

Крайне желательно потратить на эту трансформацию не более одной недели, чтобы успеть выполнить следующие ДЗ.

## Решение

Мы выделим функционал ленты постов в отдельный Feed service, тем самым оставим в Posts service только CRUD-операции.

Feed service будет отвечать за:

1. Отдачу актуальной ленты для активных пользователей
2. Бизнес-логику построения ленты для новых или давно не заходивших в систему пользователей
3. Кэширование ленты активных пользователей

Активным пользователь считается тот, кто заходил в последние двое суток — именно столько мы будем хранить и актулизировать ленту.

Еще один сервис мы назовем FanOut Service. В его задачи войдет:

1. Получать от Posts service события по созданию новых постов
2. Получать список друзей автора поста
3. Бизнес-логику по определению друзей, кому отправлять новый пост в ленту

За событиями от FanOut Service наблюдает Feed Service. 

Так же потребуется доработка User service, чтобы он мог передавать только активных друзей и данная логика сохранилась в нем.

Реализацию веб-сокетного соединения возложим на Feed service, так как это деталь реализации и у нее нет отдельного контекста в DDD.

Коммуникацию между сервисами обеспечит RabbitMQ. 

## Причины

На появление двух новых сервисов повлияли следующие факторы:

1. Создание постов должно иметь высокий throughput, чтобы пользователи не ждали сохранения новых постов. Формирование ленты, получение 
списка друзей, определение кому именно сделать рассылку, веб-сокетное соединение — всё это не его отвественность.
2. Лента должна иметь высокий RPS, чтобы пользователи получали ее мгновенно при входе в приложение. Мы не должны грузить ее процессами 
поиска активных пользователей, определения селебрити. В тоже время мы добавляем в нее функционал веб-сокетов для максимального 
быстродействия.
3. Так как ни один из вышеперечисленных сервисов не может взять на себя логику по определению получаетелей постов — мы выделяем новый сервис.
4. Так как мы сильно ограничены во времени — мы используем только RabbitMQ.

## Последствия

Основные компромисы данного архитектурного решения в том, что мы не используем Kafka. Именно через в нее должен публиковать сообщения 
Posts service, чтобы сохранять исторические данные.
