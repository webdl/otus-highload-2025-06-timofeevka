| Статус     | Дата       |
|------------|------------|
| Предложено | 2025-10-20 |

# ADR-001: Эволюция архитектуры сервиса постов

## Контекст и изложение проблемы

Новые требования от бизнеса: лента постов должна обновляться в режиме реального времени у пользователей, находящихся онлайн.

Для решения потребуется добавить в сервис постов поддержку веб-сокетов. В текущей архитектуре сервис постов отвечает за CRUD-операции и
формирование ленты постов для пользователей, что само по себе нарушает SRP, а при добавлении веб-сокетов мы рискуем получить нестабильный,
сложный в развитии и тестировании сервис.

## Драйверы

- Требование ДЗ: отображение новых постов в ленте в режиме реального времени
- Требование ДЗ: формирование ленты работает через очередь
- Требование ДЗ: при реализации обязательно обеспечить отправку только целевым пользователям это событие
- Требвоание ДЗ (опционально): избежать "эффекта Леди Гаги"
- одна неделя на всю трансформацию, чтобы успеть выполнить следующие ДЗ

## Рассмотренные варианты

1. Добавить веб-сокеты в текущий Posts service
2. Разделить Posts service на микросервисы, только Rabbit, без отдельного WS-service
3. Разделить Posts service на микросервисы, Rabbit + Kafka, с отдельным WS-service

## Результат решения

Выбранный вариант: "Разделить Posts service на микросервисы, только Rabbit, без отдельного WS-service", потому что удовлетворяет указанным 
драйверам и не нарушает SRP.

### Последствия

- Хорошо, можно реализовать за неделю
- Плохо, в будущем придется добавлять недостающие компоненты (Kafka, WS-service) и переписать код коммуникации

## Детализация решения

Работы будут проведены над четырьмя сервисами. На уровне C2 архитектура будет выглядеть так:

![C2_v2.svg](../arch/c4/C2_v2.svg)

Коммуникацию между сервисами обеспечит RabbitMQ.

### Posts service

Функционал ленты постов из Posts service переедет в отдельный Feed service, тем самым оставим в Posts service только CRUD-операции. При
этом коммуникация между сервисами будет проходить по Event Driven и REST API.

![C3-posts-service_v2.svg](../arch/c4/C3-posts-service_v2.svg)

### Feed service

Новый сервис будет отвечать за:

1. Отдачу актуальной ленты для активных пользователей через веб-сокеты
2. Построения ленты для новых или давно не заходивших в систему пользователей
3. Кэширование ленты активных пользователей

Реализацию веб-сокетного соединения возложена на данный сервис, так как это деталь реализации и у нее нет отдельного контекста в DDD.

![C3-feed-service_v1.svg](../arch/c4/C3-feed-service_v1.svg)

### Posts fanout service

Еще один сервис мы назовем Posts fanout service. В его задачи войдет:

1. Получать от Posts service события по созданию новых постов
2. Получать список друзей автора поста
3. Определение друзей, кому отправлять новый пост в ленту
4. Передачу команды на обновление ленты в Feed service

\<arh scheme TBD\>

### User service

Сервис должен уметь передавать только активных пользователей в списке друзей. Активным пользователь считается тот, кто заходил за последние
сутки — именно столько мы будем хранить и актулизировать ленты.

## Плюсы и минусы вариантов

### Добавить веб-сокеты в текущий Posts service

- Хорошо, потому что быстро делать
- Плохо, потому что не удовлетворяет драйверам
- Плохо, потому что нарушает SRP

### Разделить Posts service на микросервисы, только Rabbit, без отдельного WS-service

- Хорошо, можно реализовать за неделю
- Плохо, в будущем придется добавлять недостающие компоненты (Kafka, WS-service) и переписать код коммуникации
- Плохо, если другим сервисам потребуется уведомление о новых постах, они будут вынуждены реализовать их получение через Rabbit

### Разделить Posts service на микросервисы, Rabbit + Kafka, с отдельным WS-service

- Хорошо, потому что это надежное, масштабируемое решение удовлетворяющее современным подходам
- Плохо, что в реализации займет в 2 раза больше времени 

